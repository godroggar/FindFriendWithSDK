"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ZipPlugin(e){this.options=e}function copyfile(e,i,t){if(_fs2.default.existsSync(e)){if(/.+\.9\.png$/.test(_path2.default.basename(e))){var a=_path2.default.isAbsolute(i)?i:_path2.default.join(projDir,i);_aaptjs2.default.singleCrunch(e,a,function(a){a&&_utils.colorconsole.log("### App Loader ### 资源文件 ${srcpath}, 转换失败: "+a),t(e,i)})}else{var s=_fs2.default.createReadStream(e),r=_fs2.default.createWriteStream(i);s.pipe(r),s.on("close",function(){r.end(),t(e,i)})}}}function parse(e,i,t,a){i=i||".";var s=_path2.default.posix.join(e,i),r=void 0;a.readdirSync(s).forEach(function(l){var o=_path2.default.posix.join(s,l),n=a.statSync(o);if(n.isFile()){var u=i.split(_path2.default.sep).join(_path2.default.posix.sep);r=_path2.default.posix.join(u,_path2.default.basename(l)),t(r,o)}else if(n.isDirectory()){var f=_path2.default.posix.join(i,l);parse(e,f,t,a)}})}function removeWebpackCode(e,i){return/\.js$/.test(e)?(/app\.js$/.test(e)&&(i=i.replace(/\n\W__webpack_require__\(\d+\);\n/,"\n")),i):i}var _fs=require("fs"),_fs2=_interopRequireDefault(_fs),_path=require("path"),_path2=_interopRequireDefault(_path),_jszip=require("jszip"),_jszip2=_interopRequireDefault(_jszip),_aaptjs=require("aaptjs"),_aaptjs2=_interopRequireDefault(_aaptjs),_bundle=require("./bundle"),_bundle2=_interopRequireDefault(_bundle),_child_process=require("child_process"),_child_process2=_interopRequireDefault(_child_process),_utils=require("./utils"),_shared=require("./shared"),exec=_child_process2.default.exec,projDir=process.cwd(),signFiles={debug:{privatekey:_path2.default.join(projDir,"sign/debug/private.pem"),certificate:_path2.default.join(projDir,"sign/debug/certificate.pem")},release:{privatekey:_path2.default.join(projDir,"sign/release/private.pem"),certificate:_path2.default.join(projDir,"sign/release/certificate.pem")}};ZipPlugin.prototype.apply=function(e){var i=this.options;e.plugin("done",function(){var e=this.outputFileSystem,t=i.sign;if(!1===t?signFiles.mode=signFiles.debug:!0===t&&(signFiles.mode=signFiles.release),signFiles.mode&&!_fs2.default.existsSync(signFiles.mode.privatekey))return void _utils.colorconsole.log("### App Loader ### 缺少私钥文件, 打包失败: "+signFiles.mode.privatekey);if(signFiles.mode&&!_fs2.default.existsSync(signFiles.mode.certificate))return void _utils.colorconsole.log("### App Loader ### 缺少证书文件, 打包失败: "+signFiles.mode.certificate);var a=i.res,s=Object.keys(a).length,r=function(a,r){if(/manifest\.json$/.test(r)&&(0,_shared.updateProjectManifest)(r,i),!(--s>0)){_utils.colorconsole.log("### App Loader ### 编译完成, 生成压缩包"),(0,_utils.mkdirsSync)(i.output);var l=[],o=_path2.default.join(i.output,"bundle."+(new Date).getTime()+".zip"),n=i.src;if(_fs2.default.existsSync(n)){var u=_fs2.default.createWriteStream(o),f=new _jszip2.default;u.on("finish",function(){if(signFiles.mode){_utils.colorconsole.log("### App Loader ### 压缩包加签名");var e=_path2.default.join(i.output,i.name+".rpk");t&&(e=e.replace(/\.rpk$/,".signed.rpk"));var a=_fs2.default.readFileSync(signFiles.mode.privatekey),s=_fs2.default.readFileSync(signFiles.mode.certificate);_bundle2.default.signZip({zip:o,files:l},a,s,e),_fs2.default.existsSync(o)&&_fs2.default.unlinkSync(o);var r=_path2.default.join(__dirname,"../../","server");exec("cd "+r+" && node ./command/notify.js",function(e,i,t){e?_utils.colorconsole.log("### App Loader ### 自动刷新执行build失败 :"+t):_utils.colorconsole.log("### App Loader ### 自动刷新执行build :"+i)})}}),e.readdirSync?(parse("/",".",function(i,t){var a=removeWebpackCode(t,e.readFileSync(t).toString());void 0!==a&&(l.push({name:Buffer.from(i),file:t,hash:_bundle2.default.hashFile(t,e)}),f.file(i,a))},e),parse(n,".",function(e,i){l.push({name:Buffer.from(e),file:i,hash:_bundle2.default.hashFile(i,_fs2.default)}),f.file(e,_fs2.default.createReadStream(i))},_fs2.default)):parse(n,".",function(e,i){l.push({name:Buffer.from(e),file:i,hash:_bundle2.default.hashFile(i,_fs2.default)}),f.file(e,_fs2.default.createReadStream(i))},_fs2.default);var p={compression:"DEFLATE",compressionOptions:{level:9}};f.generateNodeStream(p).pipe(u)}}};Object.keys(a).forEach(function(e){var i=a[e],t=_path2.default.dirname(e);(0,_utils.mkdirsSync)(t),_fs2.default.existsSync(t)?copyfile(i,e,r):(_fs2.default.mkdirSync(t),copyfile(i,e,r))})})},module.exports=ZipPlugin;